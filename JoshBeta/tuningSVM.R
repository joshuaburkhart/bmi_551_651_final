# BMI 651: Tuning SVM

library(MASS)
library(plyr) #this must be loaded before dplyr
library(dplyr)
library(ggplot2)
library(broom)
library(knitr)
library(magrittr)
library(reshape2)
library(infotheo)
library(stats)
library(car)
library(e1071)
library(bnlearn)
library(elmNN)
library(gbm)
library(stats)
set.seed(2013)

setwd("~/SoftwareProjects/bmi_551_651_final/JoshBeta")

# gene id cols, cell line rows
expression <-
read.table(
"../data/expression.tsv",header = TRUE,sep = "\t",quote = "",row.names =
1,check.names = FALSE,stringsAsFactors = FALSE
)

# subtype cols, cell line rows
subtypes <-
read.table(
"../data/subtypes.txt",header = TRUE,sep = "\t",row.names = 1,check.names =
TRUE
)
subtypes[,1] <- subtypes[,1] %>% as.numeric()

for (subtype_num in 1:max(subtypes[,1]))
{
    zeros <- rep(0,nrow(subtypes))
    zeros[which(subtypes[,1] %>% as.numeric() == subtype_num)] <- 1
    subtypes <- cbind(subtypes,zeros)
}

# drug cols, cell line rows
training.classes <-
t(
read.table(
"../data/training_set_answers.txt",header = TRUE,sep = "\t",check.names = FALSE
)
)
training.classes[,1:ncol(training.classes)] <-
training.classes[,1:ncol(training.classes)] %>% as.numeric()

# Usage, id, drug, cell line columns, values in rows
scoring_and_test_set_id_mappings <-
read.table(
"../data/scoring_and_test_set_id_mappings.csv",header = TRUE,sep = ",",check.names =
FALSE
)

sae <- expression

for (subtype_num in 2:(max(subtypes[,1]) + 1))
{
    # organize subtypes, expression, train, test, classes...
    subtype_df <-
    data.frame(t(subtypes[,subtype_num]),check.names = FALSE)
    colnames(subtype_df) <- colnames(expression)
    sae <- rbind(subtype_df,sae)
}

# split training data and kaggle holdout
training.features <- sae[,colnames(training.classes)]
kaggle.features <-
sae[setdiff(colnames(sae),colnames(training.classes))]

print("Loading feature indeces...")
x.all_features <- vector("list",12)
x.all_features[[1]] <-
c(330,431,586,833,1243,2720,3013,3510,3980,4544,4801,5108,5580,6065,6097,7152,7883,8226,8704,8817,9043,9660,9969,10815,12168,12454,12900,13639,13969,13998,14370,14424,15974,16297,17449,17759
)
x.all_features[[2]] <-
c(
10,14,37,102,132,144,152,189,199,244,257,349,357,375,396,470,513,519,530,575,681,686,687,699,707,779,791,801,802,813,829,870,972,988,1020,1064,1076,1086,1087,1088,1090,1106,1169,1173,1257,1303,1304,1334,1403,1419,1444,1471,1483,1569,1572,1589,1724,1761,1830,1837,1865,1891,1919,1942,1967,1973,1983,1986,1992,2064,2103,2104,2122,2137,2203,2306,2308,2377,2383,2422,2437,2445,2457,2464,2475,2561,2607,2646,2654,2665,2694,2696,2708,2792,2810,2818,2822,2855,2865,2894,2903,2910,2945,2959,3007,3021,3024,3107,3131,3255,3284,3287,3297,3396,3416,3456,3530,3629,3634,3683,3714,3750,3767,3779,3825,3868,3883,4145,4166,4206,4212,4220,4236,4274,4328,4342,4359,4361,4394,4460,4466,4471,4529,4530,4537,4567,4665,4670,4682,4766,4779,4876,4900,4953,5036,5048,5053,5062,5083,5092,5094,5142,5250,5256,5314,5373,5375,5383,5467,5576,5582,5603,5639,5682,5732,5875,5879,5883,5892,5900,5904,5937,6041,6061,6094,6098,6114,6125,6225,6263,6317,6335,6355,6393,6401,6407,6580,6607,6623,6644,6672,6850,6860,6902,6940,6958,7106,7162,7195,7202,7222,7259,7282,7287,7418,7513,7545,7549,7568,7569,7580,7608,7625,7688,7695,7722,7735,7751,7793,7799,7855,7857,7872,7884,7891,7912,7942,7945,7946,8035,8048,8097,8118,8237,8255,8274,8355,8368,8375,8394,8500,8520,8521,8532,8561,8641,8694,8703,8787,8862,8886,9062,9091,9127,9139,9142,9158,9191,9223,9254,9286,9353,9354,9357,9368,9399,9402,9429,9596,9636,9678,9717,9748,9768,9789,9837,9841,10007,10014,10025,10074,10076,10153,10177,10220,10232,10261,10268,10470,10472,10489,10524,10542,10595,10695,10718,10775,10789,10799,10808,10857,10974,10990,11019,11038,11039,11040,11173,11179,11180,11224,11241,11245,11258,11272,11273,11302,11313,11320,11337,11389,11393,11417,11431,11435,11468,11477,11512,11540,11570,11587,11619,11663,11705,11711,11785,11868,11884,11888,11905,11946,11986,11991,11996,12036,12040,12061,12128,12133,12136,12286,12350,12351,12407,12425,12486,12491,12516,12524,12537,12554,12560,12647,12666,12701,12735,12780,12798,12917,12922,12959,12976,13014,13022,13165,13180,13199,13207,13272,13312,13326,13359,13370,13371,13438,13486,13487,13494,13496,13507,13509,13544,13550,13571,13582,13627,13652,13669,13731,13739,13798,13817,13878,13887,13891,13898,13928,13968,13975,13983,13997,14020,14038,14080,14084,14086,14090,14127,14180,14185,14201,14218,14221,14266,14312,14410,14444,14460,14477,14491,14540,14575,14714,14762,14779,14814,14818,14892,14958,15009,15151,15157,15171,15190,15209,15227,15299,15333,15346,15382,15383,15404,15408,15427,15469,15492,15500,15522,15551,15554,15574,15577,15591,15698,15789,15816,15887,15890,15909,15944,15969,16072,16118,16232,16316,16330,16334,16374,16422,16438,16442,16500,16514,16601,16621,16705,16730,16741,16751,16984,17020,17026,17048,17086,17111,17141,17187,17195,17198,17254,17257,17287,17319,17461,17471,17486,17500,17513,17542,17562,17565,17569,17606,17630,17631,17686,17732,17746,17747,17766,17770,17829,17833,17895,17914,17952,17954,17975,17981,18066,18091,18104,18107,18117,18124,18189,18226,18237,18257,18270,18311,18313,18336,18350,18358,18380,18490,18601
)
x.all_features[[3]] <-
c(
10,11,14,23,32,37,39,57,72,81,96,99,102,129,132,146,152,163,180,189,193,199,244,255,257,264,286,297,298,326,330,349,357,359,373,376,389,409,429,456,457,467,492,513,519,530,533,575,589,606,615,628,667,683,686,687,725,743,791,801,802,813,840,868,903,927,952,953,988,994,1010,1020,1035,1050,1064,1066,1076,1081,1086,1087,1088,1090,1117,1129,1141,1158,1169,1173,1175,1188,1194,1229,1249,1268,1278,1280,1281,1287,1303,1304,1313,1334,1339,1350,1354,1384,1403,1419,1438,1442,1444,1463,1471,1499,1514,1521,1526,1572,1583,1596,1598,1601,1627,1632,1636,1639,1640,1641,1654,1668,1721,1724,1730,1764,1771,1772,1788,1802,1808,1818,1826,1830,1837,1845,1846,1875,1876,1884,1898,1919,1938,1942,1952,1953,1960,1967,1968,1971,1973,1982,1992,2002,2007,2055,2061,2086,2103,2104,2137,2144,2155,2156,2170,2191,2203,2242,2272,2299,2300,2318,2334,2363,2377,2395,2422,2430,2437,2457,2464,2475,2485,2492,2494,2498,2510,2518,2537,2551,2561,2598,2602,2614,2646,2649,2655,2657,2659,2665,2682,2687,2693,2696,2719,2753,2757,2772,2777,2792,2799,2813,2818,2849,2862,2865,2872,2894,2910,2913,2917,2931,2943,2945,2987,2988,3007,3024,3052,3060,3076,3103,3104,3112,3127,3130,3179,3181,3186,3188,3200,3220,3255,3256,3278,3284,3287,3297,3301,3311,3313,3319,3325,3333,3348,3393,3401,3416,3418,3456,3461,3463,3465,3487,3488,3530,3556,3581,3629,3645,3688,3694,3698,3750,3758,3763,3764,3779,3800,3801,3807,3820,3868,3906,3993,4138,4145,4158,4165,4166,4169,4170,4182,4206,4213,4214,4216,4220,4236,4237,4262,4277,4286,4290,4307,4315,4324,4329,4342,4359,4361,4431,4458,4460,4466,4471,4497,4502,4508,4536,4537,4555,4558,4582,4585,4597,4600,4637,4659,4682,4690,4712,4715,4744,4766,4785,4800,4804,4816,4838,4840,4847,4870,4882,4884,4900,4925,4958,4974,4999,5083,5094,5099,5125,5142,5147,5168,5179,5199,5201,5208,5216,5221,5244,5269,5297,5298,5301,5322,5373,5375,5383,5384,5421,5462,5467,5536,5559,5567,5570,5576,5582,5603,5617,5638,5660,5664,5666,5675,5689,5692,5713,5716,5720,5732,5742,5778,5786,5789,5796,5870,5873,5875,5879,5883,5885,5899,5916,5937,5965,5991,6041,6053,6056,6061,6081,6094,6097,6098,6114,6116,6125,6143,6170,6174,6225,6233,6238,6244,6263,6279,6281,6290,6315,6334,6335,6336,6355,6384,6393,6401,6406,6407,6408,6478,6536,6575,6580,6592,6644,6669,6672,6691,6699,6704,6726,6733,6739,6746,6779,6789,6835,6837,6845,6860,6878,6879,6885,6896,6902,6914,6940,6961,6977,6980,6990,7010,7026,7038,7040,7041,7056,7061,7062,7076,7106,7120,7139,7140,7162,7168,7180,7181,7192,7195,7202,7222,7243,7257,7259,7267,7278,7282,7287,7295,7308,7312,7316,7381,7386,7404,7418,7429,7455,7473,7506,7509,7513,7523,7531,7536,7569,7582,7593,7608,7625,7647,7681,7688,7693,7695,7699,7709,7719,7722,7733,7735,7751,7754,7764,7772,7793,7811,7820,7873,7884,7891,7902,7911,7912,7919,7933,7945,7946,7953,7959,7961,7964,7967,7974,7978,8035,8041,8045,8048,8061,8065,8096,8097,8118,8126,8146,8186,8191,8197,8205,8212,8255,8269,8274,8275,8290,8294,8311,8323,8333,8353,8355,8359,8360,8368,8392,8417,8500,8520,8521,8561,8574,8580,8584,8585,8592,8593,8597,8616,8618,8623,8631,8642,8654,8723,8738,8746,8792,8803,8814,8840,8846,8857,8862,8867,8872,8877,8882,8886,8926,8952,8963,9012,9032,9035,9047,9055,9056,9058,9062,9070,9076,9158,9189,9191,9246,9274,9284,9340,9353,9354,9357,9360,9368,9399,9406,9407,9479,9531,9536,9540,9636,9646,9678,9690,9697,9707,9748,9763,9768,9772,9789,9837,9850,9871,9893,9909,9925,9939,9965,9976,9981,9984,9994,10007,10025,10048,10059,10064,10074,10076,10089,10095,10113,10117,10153,10159,10161,10163,10166,10171,10177,10201,10220,10231,10232,10268,10273,10288,10298,10306,10329,10351,10352,10375,10404,10413,10422,10425,10434,10447,10472,10481,10510,10511,10520,10542,10558,10573,10581,10595,10628,10649,10670,10695,10703,10704,10734,10748,10752,10775,10788,10789,10799,10801,10808,10838,10844,10848,10857,10885,10901,10917,10919,10947,10974,10982,10984,11019,11020,11038,11040,11044,11064,11066,11082,11102,11113,11132,11159,11173,11179,11196,11199,11215,11220,11245,11255,11258,11260,11264,11272,11273,11293,11297,11307,11310,11313,11337,11343,11358,11363,11389,11393,11416,11431,11433,11435,11444,11454,11462,11468,11469,11477,11512,11519,11540,11555,11584,11587,11619,11631,11640,11653,11657,11663,11683,11686,11711,11739,11747,11752,11754,11764,11784,11815,11823,11835,11862,11868,11888,11897,11905,11925,11946,11953,11991,12030,12036,12041,12056,12061,12072,12081,12121,12123,12133,12180,12185,12188,12231,12246,12252,12278,12308,12320,12350,12351,12400,12407,12425,12426,12431,12438,12452,12453,12463,12468,12475,12479,12491,12524,12526,12537,12546,12560,12572,12647,12664,12671,12701,12727,12741,12773,12780,12787,12798,12838,12841,12845,12881,12917,12922,12930,12931,12943,12948,12952,12959,12983,12986,13012,13014,13022,13028,13071,13138,13183,13197,13207,13211,13219,13240,13271,13272,13280,13282,13294,13301,13306,13312,13326,13359,13371,13373,13397,13403,13426,13431,13438,13457,13486,13489,13496,13507,13509,13543,13544,13550,13571,13582,13587,13591,13611,13627,13643,13646,13648,13652,13668,13669,13675,13677,13680,13691,13695,13698,13707,13714,13731,13739,13761,13762,13772,13817,13883,13885,13887,13891,13898,13928,13934,13935,13959,13963,13975,13997,13999,14020,14028,14033,14038,14066,14074,14080,14082,14084,14086,14090,14096,14104,14127,14148,14159,14180,14184,14185,14195,14201,14218,14221,14223,14233,14243,14249,14266,14268,14291,14308,14312,14315,14321,14333,14350,14352,14357,14400,14410,14411,14418,14425,14444,14460,14463,14467,14477,14478,14491,14528,14536,14540,14553,14570,14575,14597,14598,14628,14630,14638,14678,14704,14727,14756,14758,14779,14781,14787,14797,14801,14814,14815,14818,14843,14845,14892,14927,14944,14953,14976,14978,14987,15006,15008,15035,15079,15102,15151,15154,15171,15175,15209,15227,15244,15269,15275,15299,15346,15349,15354,15356,15383,15395,15404,15405,15408,15409,15410,15428,15438,15459,15465,15469,15492,15500,15522,15554,15574,15614,15621,15627,15652,15671,15698,15749,15807,15824,15825,15842,15890,15897,15909,15922,15929,15944,15949,15967,15969,16007,16038,16042,16047,16072,16080,16118,16173,16177,16184,16206,16240,16242,16244,16253,16256,16257,16261,16279,16289,16293,16296,16299,16316,16319,16330,16362,16368,16374,16384,16422,16433,16438,16442,16463,16468,16477,16500,16514,16536,16560,16587,16588,16601,16611,16613,16625,16663,16683,16685,16690,16705,16707,16723,16741,16742,16751,16758,16776,16787,16804,16821,16877,16915,16920,16970,16984,17012,17020,17026,17042,17086,17095,17110,17111,17118,17141,17144,17171,17184,17195,17198,17224,17226,17237,17254,17257,17275,17287,17292,17335,17368,17428,17461,17469,17500,17510,17513,17536,17542,17562,17565,17569,17606,17609,17622,17629,17630,17631,17633,17641,17673,17683,17686,17688,17705,17727,17746,17747,17770,17826,17843,17895,17905,17909,17914,17952,17954,17959,17975,17982,17988,18029,18033,18049,18066,18091,18100,18104,18107,18114,18124,18127,18128,18173,18175,18199,18202,18204,18223,18226,18236,18257,18269,18270,18291,18313,18325,18336,18356,18358,18380,18382,18386,18414,18435,18486,18490,18499,18502,18524,18542,18547,18559,18593,18601,18616,18627
)
x.all_features[[4]] <-
c(
211,1222,2137,2170,3020,3045,3065,4215,4448,4688,5337,5779,5782,6179,6564,6808,6901,6948,6965,6999,7946,8013,8772,9149,9256,9319,9841,10385,10415,10882,11511,12247,12270,12536,12956,14649,15094,15701,16649,16721,17635,18263
)
x.all_features[[5]] <-
c(
10,11,52,240,252,257,327,364,470,525,765,779,812,840,904,1012,1013,1025,1054,1084,1086,1087,1107,1117,1134,1345,1403,1571,1602,1608,1640,1692,1700,1724,1730,1884,1940,2011,2078,2136,2149,2186,2336,2379,2562,2646,3138,3200,3278,3418,3521,3527,3551,3604,3750,3785,3821,3830,3835,4087,4092,4145,4186,4425,4481,4505,4639,4782,4890,4982,5036,5301,5308,5372,5439,5552,5616,5638,5723,5789,5797,5821,6010,6029,6097,6146,6205,6214,6218,6336,6342,6592,6980,7078,7138,7139,7168,7185,7257,7282,7332,7413,7569,7649,7728,7768,7856,7958,7961,8054,8262,8264,8279,8323,8354,8592,8657,8910,9008,9012,9091,9167,9231,9406,9446,9564,9660,9763,9821,10038,10094,10153,10162,10424,10428,10467,10485,10495,10555,10639,10654,10737,10775,10849,10895,11068,11151,11303,11305,11435,11452,11552,11613,11663,11927,12066,12281,12314,12337,12638,12647,12680,12729,12838,12917,12924,12948,12995,13306,13580,13652,13669,13675,13714,13761,13803,13859,13885,13902,13975,13987,14105,14180,14195,14255,14312,14377,14444,14555,14575,14637,14696,14708,14749,14953,15031,15145,15188,15403,15410,15430,15533,15563,15587,15627,15949,16118,16163,16196,16224,16253,16267,16305,16333,16339,16407,16569,16607,16613,16682,16776,16857,17005,17120,17278,17341,17411,17522,17523,17653,17688,17709,17727,17747,17766,17767,17905,17913,17945,18006,18066,18067,18094,18142,18270,18389,18416,18486,18547,18559
)
x.all_features[[6]] <-
c(
5,10,11,112,189,217,236,237,250,252,298,306,330,366,396,429,507,513,640,675,759,801,829,840,944,953,956,1013,1019,1034,1057,1087,1117,1123,1134,1141,1162,1186,1193,1220,1243,1257,1289,1334,1345,1354,1532,1560,1572,1600,1639,1642,1662,1762,1766,1769,1786,1793,1802,1830,1850,1870,1926,1968,1973,2005,2070,2086,2103,2144,2221,2299,2324,2414,2415,2440,2445,2476,2519,2539,2542,2561,2614,2657,2719,2766,2769,2792,2811,2838,2849,2911,2959,3005,3007,3014,3034,3063,3081,3204,3222,3291,3346,3353,3404,3409,3454,3459,3461,3487,3528,3565,3604,3650,3651,3653,3674,3693,3701,3714,3746,3784,3793,3825,3830,3906,3930,4125,4183,4185,4212,4233,4236,4274,4315,4324,4342,4487,4488,4497,4586,4590,4597,4635,4700,4712,4724,4743,4756,4876,4900,4923,4974,5038,5069,5090,5094,5142,5158,5221,5375,5467,5516,5533,5535,5578,5607,5648,5667,5669,5699,5751,5756,5785,5797,5821,5832,5891,5900,5974,6009,6010,6022,6052,6066,6097,6169,6217,6244,6299,6329,6334,6349,6407,6414,6452,6575,6579,6583,6613,6642,6644,6658,6669,6730,6850,6880,6909,6912,6993,7035,7040,7106,7113,7120,7136,7182,7185,7202,7237,7293,7326,7330,7381,7387,7466,7513,7568,7569,7584,7623,7682,7695,7714,7722,7730,7785,7793,7811,7851,7861,7872,7911,7933,8019,8085,8097,8124,8163,8191,8199,8237,8281,8294,8307,8333,8368,8371,8394,8500,8530,8618,8644,8703,8857,8902,8918,8945,8951,8982,9008,9023,9070,9073,9091,9100,9117,9158,9189,9196,9243,9284,9292,9329,9344,9368,9381,9402,9414,9462,9479,9548,9568,9578,9593,9611,9660,9661,9760,9763,9843,9950,9994,10019,10025,10039,10048,10056,10058,10166,10220,10278,10411,10437,10467,10492,10524,10538,10554,10573,10614,10621,10683,10695,10775,10832,10840,10880,10902,11086,11092,11094,11114,11173,11199,11236,11245,11258,11260,11271,11329,11338,11417,11433,11450,11452,11514,11522,11539,11558,11591,11623,11624,11667,11711,11769,11786,11868,11888,11903,11992,12036,12047,12066,12073,12121,12123,12128,12129,12149,12155,12173,12193,12235,12252,12312,12336,12337,12408,12494,12537,12546,12554,12560,12572,12592,12605,12638,12660,12693,12725,12735,12737,12781,12872,12876,12950,12976,12977,12986,13014,13057,13078,13121,13165,13169,13180,13188,13413,13496,13519,13523,13543,13564,13571,13613,13617,13627,13639,13652,13654,13671,13680,13687,13706,13707,13737,13775,13820,13898,13908,13918,13985,13987,13997,13998,14100,14127,14167,14185,14195,14208,14221,14233,14268,14278,14468,14473,14553,14580,14619,14678,14797,14814,14829,14864,14865,14896,14901,14916,14917,14923,14958,14959,14981,15111,15122,15157,15161,15171,15188,15215,15231,15244,15299,15334,15353,15354,15395,15410,15428,15430,15438,15522,15533,15576,15594,15606,15627,15698,15722,15729,15798,15832,15870,15875,15909,15924,15955,16184,16225,16319,16374,16416,16421,16500,16521,16569,16584,16606,16641,16673,16690,16705,16710,16742,16824,16830,16869,16915,16935,17027,17086,17102,17111,17117,17175,17187,17237,17238,17254,17275,17280,17287,17321,17390,17404,17434,17453,17486,17500,17506,17513,17534,17552,17586,17606,17630,17653,17668,17669,17684,17723,17746,17747,17816,17821,17822,17885,17905,17983,18106,18115,18142,18144,18179,18213,18235,18241,18250,18275,18284,18311,18364,18382,18386,18397,18471,18472,18480,18558,18579,18593,18624
)
x.all_features[[7]] <-
c(
34,42,71,72,190,310,335,353,412,497,569,621,715,719,867,869,874,875,907,922,968,985,1072,1095,1108,1110,1129,1247,1262,1292,1321,1339,1385,1460,1462,1494,1513,1575,1660,1667,1668,1690,1696,1771,1780,1808,1818,1857,1873,1877,1951,1953,1955,1987,1997,2040,2051,2068,2099,2210,2229,2481,2525,2558,2571,2583,2588,2604,2629,2664,2695,2704,2741,2777,2779,2801,2851,3004,3011,3024,3039,3059,3077,3131,3139,3150,3177,3251,3535,3556,3576,3772,3776,3786,3797,3820,3843,3873,3922,3972,3983,4050,4141,4147,4169,4192,4227,4249,4259,4377,4404,4461,4554,4600,4617,4631,4648,4649,4659,4704,4715,4729,4847,4895,4991,4999,5084,5123,5181,5283,5301,5305,5384,5461,5472,5474,5577,5618,5640,5644,5690,5725,5746,5809,6029,6070,6261,6388,6553,6573,6679,6688,6752,6785,6793,6990,7071,7084,7086,7123,7139,7170,7272,7297,7331,7364,7372,7394,7475,7482,7491,7558,7566,7576,7641,7720,7802,7852,7899,7941,7983,7988,8042,8118,8131,8140,8154,8159,8167,8257,8346,8411,8608,8623,8645,8950,9033,9128,9210,9391,9686,9716,9724,9772,9793,9834,9976,9990,10031,10106,10159,10247,10380,10383,10440,10520,10531,10617,10642,10664,10726,10765,10848,10851,10899,10900,10922,10927,10941,11095,11106,11119,11150,11170,11174,11192,11247,11279,11290,11336,11407,11408,11434,11461,11488,11579,11653,11724,11847,11984,12021,12054,12092,12187,12212,12260,12272,12539,12544,12598,12619,12684,12759,12800,12871,12939,12964,13017,13084,13085,13160,13179,13226,13265,13362,13397,13426,13468,13482,13485,13514,13524,13605,13609,13626,13642,13649,13686,13996,14008,14053,14054,14058,14066,14070,14087,14113,14161,14282,14348,14363,14369,14374,14419,14576,14614,14620,14719,14740,14877,14935,14956,15074,15113,15146,15168,15287,15294,15462,15476,15548,15689,15779,15816,15824,15844,15847,15895,15989,16013,16239,16242,16249,16277,16379,16444,16503,16638,16661,16697,16731,16759,16761,16773,16776,16811,16826,17000,17020,17123,17172,17236,17248,17259,17262,17272,17348,17441,17515,17551,17566,17590,17608,17632,17641,17667,17677,17753,17951,17952,18000,18075,18186,18191,18204,18254,18327,18356,18429,18513,18588,18616
)
x.all_features[[8]] <-
c(
20,21,28,32,34,42,44,46,56,71,85,99,132,146,168,180,193,199,205,233,246,255,277,283,286,287,293,310,311,359,373,376,379,386,391,414,448,451,462,499,519,543,567,615,656,659,667,683,692,703,719,725,738,750,760,791,799,800,805,818,831,836,845,867,868,891,898,909,926,938,948,955,959,968,993,1001,1007,1012,1018,1026,1028,1055,1064,1065,1069,1072,1109,1110,1140,1155,1158,1170,1188,1200,1216,1234,1276,1297,1301,1305,1314,1319,1320,1321,1351,1360,1362,1363,1394,1400,1415,1425,1426,1435,1445,1452,1460,1462,1480,1488,1494,1505,1508,1518,1538,1554,1581,1583,1584,1598,1652,1663,1667,1668,1672,1681,1693,1734,1736,1759,1761,1771,1791,1806,1817,1823,1840,1857,1867,1868,1876,1877,1880,1889,1899,1933,1935,1943,1951,1953,1955,1957,1971,1991,1992,1994,2018,2038,2040,2048,2051,2055,2062,2079,2100,2101,2102,2111,2164,2190,2205,2207,2209,2210,2214,2223,2229,2252,2255,2257,2258,2259,2286,2325,2326,2365,2376,2386,2391,2401,2425,2446,2461,2466,2481,2485,2505,2506,2518,2548,2558,2571,2583,2586,2592,2598,2599,2608,2629,2632,2666,2686,2691,2695,2696,2700,2701,2711,2713,2725,2732,2741,2777,2798,2803,2805,2807,2810,2841,2852,2860,2868,2878,2898,2940,2943,2945,2964,2965,2973,2974,2980,2997,3022,3048,3062,3070,3077,3107,3139,3177,3181,3197,3216,3220,3241,3256,3263,3279,3296,3308,3313,3325,3334,3352,3381,3389,3392,3400,3425,3436,3444,3445,3458,3469,3491,3504,3535,3537,3542,3556,3558,3560,3569,3576,3582,3599,3614,3620,3642,3656,3661,3664,3667,3687,3736,3738,3741,3742,3743,3747,3801,3805,3822,3840,3843,3864,3868,3885,3921,3933,3943,3951,3962,3963,3977,3984,3991,3993,4010,4020,4022,4030,4046,4050,4068,4072,4084,4094,4106,4108,4144,4169,4182,4190,4196,4211,4222,4230,4242,4243,4247,4248,4250,4259,4268,4277,4290,4293,4296,4307,4341,4349,4362,4372,4382,4400,4419,4422,4447,4476,4496,4532,4536,4549,4582,4589,4616,4632,4637,4649,4651,4652,4659,4710,4718,4734,4747,4758,4760,4772,4789,4802,4808,4815,4816,4843,4847,4849,4855,4872,4891,4899,4903,4916,4989,4993,5019,5020,5022,5029,5076,5084,5096,5128,5137,5143,5168,5177,5198,5208,5212,5272,5283,5284,5294,5336,5359,5363,5364,5373,5384,5414,5461,5462,5474,5490,5493,5494,5498,5499,5500,5503,5507,5515,5521,5555,5565,5566,5567,5576,5595,5597,5617,5618,5627,5630,5664,5666,5670,5679,5681,5686,5690,5692,5712,5790,5796,5805,5809,5810,5826,5827,5829,5853,5854,5860,5873,5875,5879,5885,5888,5893,5908,5915,5916,5919,5935,5950,5979,6064,6068,6072,6106,6107,6118,6139,6147,6166,6183,6191,6215,6233,6238,6255,6276,6301,6335,6352,6376,6378,6379,6404,6406,6412,6413,6427,6430,6439,6442,6458,6476,6480,6482,6499,6500,6509,6536,6543,6550,6559,6565,6566,6568,6578,6590,6603,6616,6619,6640,6665,6671,6679,6696,6700,6734,6737,6746,6752,6769,6786,6845,6853,6860,6861,6878,6892,6915,6920,6977,6987,6990,7013,7021,7022,7023,7026,7033,7036,7039,7061,7064,7069,7071,7084,7098,7119,7140,7199,7205,7210,7215,7226,7229,7270,7298,7308,7320,7322,7327,7342,7377,7390,7394,7412,7418,7447,7457,7471,7475,7480,7493,7529,7534,7538,7550,7562,7571,7602,7608,7609,7636,7641,7652,7683,7693,7694,7709,7710,7721,7751,7773,7776,7777,7781,7783,7827,7831,7837,7841,7852,7865,7884,7887,7918,7919,7920,7984,7988,7996,8003,8007,8035,8044,8045,8057,8061,8067,8072,8083,8084,8090,8118,8126,8131,8144,8167,8205,8213,8223,8227,8236,8246,8248,8293,8299,8340,8384,8388,8395,8417,8440,8461,8462,8464,8466,8480,8494,8495,8497,8499,8527,8545,8559,8562,8566,8571,8574,8576,8580,8584,8597,8602,8612,8613,8624,8631,8639,8646,8669,8674,8682,8695,8723,8746,8749,8750,8756,8780,8785,8787,8796,8802,8810,8822,8858,8863,8868,8872,8877,8879,8912,8925,8931,8993,8999,9011,9015,9027,9034,9040,9047,9050,9056,9064,9129,9170,9173,9218,9227,9242,9266,9271,9311,9322,9337,9348,9366,9375,9384,9395,9436,9443,9484,9495,9511,9514,9536,9540,9554,9577,9583,9601,9610,9613,9646,9650,9651,9663,9669,9673,9683,9686,9690,9700,9701,9721,9738,9748,9765,9767,9787,9788,9789,9801,9812,9815,9868,9878,9889,9903,9908,9909,9911,9922,9925,9926,9929,9931,9959,9965,9967,9977,9986,10006,10044,10063,10130,10143,10148,10150,10159,10161,10171,10222,10238,10247,10263,10277,10299,10304,10306,10328,10365,10371,10375,10380,10395,10397,10401,10418,10420,10425,10436,10444,10447,10456,10472,10497,10500,10520,10526,10534,10544,10546,10553,10561,10574,10586,10601,10610,10618,10628,10636,10645,10663,10686,10690,10703,10717,10724,10748,10750,10773,10788,10797,10804,10806,10823,10838,10864,10878,10886,10892,10896,10899,10908,10919,10927,10938,10963,10978,10982,10984,10994,11029,11042,11059,11061,11063,11066,11071,11078,11082,11106,11111,11118,11120,11142,11148,11167,11172,11184,11186,11192,11194,11215,11234,11235,11237,11242,11248,11255,11279,11285,11289,11308,11310,11316,11319,11333,11336,11343,11349,11365,11383,11385,11393,11424,11431,11434,11442,11448,11459,11469,11479,11480,11488,11498,11523,11534,11537,11543,11546,11554,11555,11583,11617,11665,11683,11693,11702,11712,11732,11744,11751,11764,11766,11768,11781,11788,11796,11838,11844,11846,11864,11877,11879,11884,11899,11912,11915,11929,11930,11943,11968,11975,12014,12030,12054,12061,12100,12106,12153,12180,12239,12240,12260,12261,12274,12278,12374,12393,12411,12415,12431,12479,12495,12499,12502,12509,12527,12535,12539,12544,12559,12585,12607,12614,12619,12623,12642,12664,12671,12673,12691,12700,12701,12704,12705,12711,12744,12750,12771,12773,12780,12783,12800,12822,12824,12830,12831,12832,12835,12845,12855,12857,12874,12884,12925,12937,12964,12975,12980,12991,13002,13007,13009,13011,13012,13017,13021,13062,13063,13077,13108,13120,13129,13139,13153,13155,13160,13168,13171,13175,13178,13204,13207,13221,13226,13246,13247,13251,13269,13270,13271,13272,13295,13325,13345,13346,13349,13372,13373,13379,13392,13397,13407,13410,13419,13426,13431,13457,13463,13465,13468,13483,13518,13531,13538,13539,13551,13555,13566,13574,13609,13624,13633,13646,13649,13667,13685,13693,13696,13708,13718,13735,13736,13762,13802,13826,13868,13869,13872,13876,13880,13883,13910,13933,13934,13935,13946,13959,13974,13976,13980,13996,14000,14007,14008,14033,14037,14054,14066,14074,14077,14087,14117,14139,14146,14153,14159,14161,14188,14192,14218,14238,14243,14248,14273,14277,14286,14287,14294,14303,14308,14313,14318,14320,14321,14323,14346,14357,14360,14392,14400,14410,14411,14413,14419,14425,14430,14445,14452,14469,14491,14504,14509,14536,14540,14541,14546,14558,14592,14600,14605,14617,14618,14620,14625,14647,14655,14666,14695,14698,14734,14737,14740,14759,14783,14793,14809,14815,14838,14847,14851,14879,14880,14911,14912,14931,14932,14944,14976,14978,14984,14997,15004,15008,15015,15025,15044,15064,15066,15067,15084,15092,15109,15121,15139,15146,15169,15204,15237,15257,15264,15273,15279,15285,15288,15388,15409,15452,15476,15514,15535,15538,15540,15555,15556,15557,15571,15582,15590,15611,15614,15625,15648,15651,15653,15670,15680,15703,15763,15773,15783,15790,15792,15793,15804,15809,15824,15827,15833,15834,15838,15844,15847,15851,15872,15876,15896,15925,15941,15968,15969,15970,15985,16007,16031,16037,16047,16050,16054,16071,16078,16134,16140,16154,16155,16165,16173,16174,16180,16208,16209,16213,16218,16236,16238,16249,16252,16262,16265,16337,16369,16377,16379,16389,16434,16436,16456,16457,16468,16472,16476,16480,16481,16483,16488,16503,16506,16537,16541,16545,16546,16547,16583,16589,16591,16630,16680,16697,16700,16731,16743,16744,16745,16751,16762,16766,16772,16777,16795,16821,16834,16870,16876,16877,16879,16946,16955,16958,16961,16962,16967,17030,17042,17044,17065,17075,17078,17099,17108,17109,17124,17137,17144,17161,17172,17191,17200,17224,17257,17260,17269,17303,17308,17330,17346,17354,17357,17388,17396,17416,17428,17437,17462,17465,17468,17519,17521,17530,17536,17539,17550,17577,17590,17600,17626,17641,17660,17676,17678,17679,17683,17698,17700,17706,17711,17730,17753,17795,17799,17824,17826,17889,17893,17916,17919,17927,17934,17939,17945,17951,17959,17965,17970,17971,17975,17976,17977,17994,18000,18014,18019,18029,18080,18091,18101,18124,18168,18173,18175,18199,18204,18206,18212,18214,18236,18252,18271,18285,18295,18303,18305,18312,18327,18335,18336,18349,18356,18381,18405,18420,18442,18456,18469,18494,18540,18559,18566,18616,18627,18636
)
x.all_features[[9]] <-
c(
7,21,99,183,186,322,484,644,659,715,762,982,1027,1059,1130,1292,1299,1512,1518,1609,1645,1725,1747,1752,1777,1896,1921,1934,1990,2097,2108,2364,2572,2695,2804,2929,2958,3004,3070,3110,3128,3288,3334,3432,3583,3692,3828,3873,4035,4159,4219,4303,4561,4699,5084,5167,5185,5211,5230,5266,5500,5546,5649,5684,5700,5975,6063,6076,6154,6245,6307,6351,6411,6499,6531,6694,6828,6851,6881,6892,6945,6989,7013,7039,7119,7147,7370,7425,7444,7456,7491,7497,7661,7717,7734,7766,7770,7783,7930,7939,8034,8068,8198,8236,8241,8311,8347,8467,8485,8548,8750,8759,8874,8887,8893,8896,8998,9089,9103,9114,9170,9542,9627,9634,9696,9731,9834,10049,10333,10337,10356,10380,10394,10478,10565,10803,10823,10871,10956,10986,11081,11128,11143,11232,11336,11582,11670,11761,11787,11851,11893,11969,12021,12206,12247,12260,12306,12406,12461,12518,12594,12665,12690,12700,12720,13002,13080,13099,13482,13594,13708,13744,14012,14130,14227,14327,14396,14423,14430,14447,14460,14621,14645,14649,14716,14771,14878,14992,15007,15032,15039,15136,15158,15167,15388,15453,15625,15640,15662,15757,15835,15840,15952,16012,16027,16093,16127,16219,16230,16275,16365,16404,16428,16476,16493,16503,16543,16585,16631,16654,16666,16697,16731,16766,16781,16816,16912,17029,17122,17132,17137,17159,17291,17330,17467,17592,17676,17755,18149,18174,18195,18263,18374,18392,18450,18551
)
x.all_features[[10]] <-
c(
30,51,164,264,369,418,436,723,736,759,768,770,793,856,1121,1171,1190,1191,1201,1343,1479,1523,1559,1706,1708,1727,1744,1750,1841,2009,2029,2041,2063,2163,2256,2306,2307,2350,2362,2555,2578,2615,2811,2824,2825,2827,2882,2921,3137,3169,3190,3240,3300,3364,3433,3455,3494,3550,3585,3604,3651,3689,3698,3877,3924,3929,4038,4109,4266,4359,4497,4526,4570,4596,4597,4622,4730,4731,4756,4814,4825,4838,4885,4994,5012,5089,5101,5105,5186,5187,5195,5262,5289,5437,5544,5556,5586,5674,5689,5741,5865,5869,5917,6009,6062,6105,6177,6253,6280,6407,6443,6494,6577,6580,6608,6611,6629,6673,6761,6808,6962,7051,7136,7166,7195,7268,7296,7395,7399,7604,7635,7686,7789,7805,7946,7966,8027,8120,8296,8344,8345,8431,8508,8518,8530,8535,8556,8677,8710,8766,8786,8871,8907,9023,9055,9354,9363,9423,9630,9640,9675,9728,9760,9874,9964,9995,10092,10116,10244,10329,10594,10614,10619,10699,10915,11230,11314,11317,11475,11524,11633,11673,11820,11833,12039,12047,12094,12188,12255,12336,12381,12385,12524,12616,12636,12648,12663,12724,12740,12763,12785,12808,13067,13072,13212,13324,13337,13344,13363,13520,13558,13575,13612,13725,13830,13900,13905,13918,13939,14013,14026,14096,14097,14154,14245,14249,14379,14499,14763,14766,14833,14890,14905,15041,15130,15155,15190,15254,15334,15370,15410,15414,15421,15537,15543,15558,15618,15622,15634,15698,15747,15766,16006,16113,16168,16181,16426,16431,16479,16622,16720,16784,16871,16983,17076,17102,17110,17120,17175,17265,17281,17295,17329,17349,17359,17379,17467,17569,17581,17721,17766,17829,17830,17891,17905,17981,18023,18064,18081,18112,18208,18248,18273,18340,18364,18397,18398,18417,18433,18435,18505,18581,18632
)
x.all_features[[11]] <-
c(
210,454,484,485,666,1105,1558,1777,1934,2044,2912,3113,3442,3740,4292,4561,4719,4798,5239,5340,5348,5715,5969,6013,6063,6104,6351,6410,6624,6736,6796,6866,7013,7329,7639,7762,7767,7908,8225,8313,8398,8744,8938,8973,9111,9275,9451,9590,9833,9842,9982,10002,10022,10154,10210,10410,10674,10991,11214,12223,12690,12694,12863,13620,13625,13724,13755,13792,14036,14056,14355,14435,14725,14771,15341,15958,16133,16169,16219,16230,16615,16654,16799,16928,16943,16998,17021,17291,18088,18103,18299
)
x.all_features[[12]] <-
c(
32,1203,1318,1502,1532,1620,1839,1846,1861,2136,2416,2701,2832,3201,3632,3776,4462,4667,4772,5244,5272,5520,5699,5805,5870,5889,6070,6154,6790,7221,7272,7300,7325,7428,8319,8579,8619,8663,8712,9131,9162,9461,9485,9614,9646,9715,10273,10885,10930,10947,11255,11654,11696,11879,12092,12157,12424,12695,12874,13431,13836,14001,14019,14662,15838,16013,16173,16391,16408,16603,17377,17397,17534,17622,17868,17934,18330
)

print("done.")

### Training and Kaggle Sets

kaggle.classes <- data.frame()
training.features_train <- data.frame()
training.classes_train <- numeric()
x.cv_err <- Inf
training.features_ncol <- numeric()
x.loop = NA
x.cv_boost <- numeric()
x.all_drug_min_errs <- numeric()
x.SPLIT <- 0.7

for (drug_idx in 1:nrow(training.classes))
{
    training.features_train <- training.features
    training.classes_train <- training.classes[drug_idx,]

    ### Cross Validation Loop

    # variables to store loop results
    x.cv_err <- Inf
    training.features_ncol <- round(x.SPLIT * ncol(training.features_train))
    x.cv_boost <- rep(1 / ncol(training.features_train),ncol(training.features_train))
    x.loop_models <- list(type=any)
    prev_avg <- NA

    for (loop in seq(1:5))
    {
        ### Split Training & Validation sets with random sampling (Monte Carlo cross validation)

        # Cross Validation
        index <- sample(1:ncol(training.features_train),round(x.SPLIT * ncol(training.features_train)),replace=TRUE,prob=x.cv_boost)
        training.features_train_cv <- training.features_train[,index]
        training.classes_train_cv <- training.classes_train[index]

        x <- seq(ncol(training.features_train))
        negative_idxs <- match(sample(x[-index],round((1-x.SPLIT) * ncol(training.features_train))),x)

        training.features_validation_cv <- training.features_train[,negative_idxs]
        training.classes_validation_cv <- training.classes_train[negative_idxs]

        #now we can retain only our selected columns
        training.features_train_w <-
        training.features_train_cv[x.all_features[[drug_idx]],]

        #add the class labels to the feature data frame
        training.train_svm_input <- as.matrix(t(training.features_train_w))
        #data.frame(t(training.features_train_w),check.names = FALSE)

        #train model
        x.model <- best.tune(svm,
            train.x = training.train_svm_input,
            train.y = training.classes_train_cv,
            ranges = list(gamma = 2^(-1:1), cost = 2^(2:4)),
            tunecontrol = tune.control(sampling = "fix"))
        #svm(
        #    x = training.train_svm_input,y = training.classes_train_cv,kernel="radial"
        #)

        x.loop_models[[loop]] <- x.model

        ### Validation (on hold out data)

        #filter features
        training.validation_svm_input <-
        data.frame(t(training.features_validation_cv[x.all_features[[drug_idx]],]), check.names = FALSE)

        x.prediction_cv <- predict(x.model,training.validation_svm_input)

        x.class_ag <-
        table(round(unlist(lapply(x.prediction_cv,function(x) {
            ifelse(x < 0,0,ifelse(x > 1,1,x))
        }))),training.classes_validation_cv) %>% classAgreement()

        #misclassification rate
        x.err_rate <- 1 - x.class_ag$diag

        print(c("loop",loop,"error rate:",x.err_rate))
        x.cv_err <- x.err_rate
        x.loop <- loop

        ### Boosting probabilities
        miscalled_idxs <- which(abs(round(x.prediction_cv) - training.classes_validation_cv)>0)
        x.cv_boost[miscalled_idxs] <- abs(x.cv_boost[miscalled_idxs] * 2)
    }
    x.all_drug_min_errs <- c(x.all_drug_min_errs,x.cv_err)

    print(c("drug:",drug_idx,"loop:",x.loop,'min drug err:', x.cv_err))#,"x.cv_boost:",x.cv_boost,"prev_avg:",prev_avg))

    ### Predict Kaggle Holdout

    #filter features
    kaggle.svm_input <-
    data.frame(t(kaggle.features[x.all_features[[drug_idx]],]), check.names = FALSE)

    kaggle.predictions <- (predict(x.loop_models[[1]],kaggle.svm_input) / x.loop)
    for(loop_it in 2:x.loop)
    {
        kaggle.predictions <- (kaggle.predictions + predict(x.loop_models[[loop_it]],kaggle.svm_input) / x.loop)
    }

    #print(c("kaggle.predictions",kaggle.predictions))

    kaggle.classes <- rbind(kaggle.classes,round(unlist(
    lapply(kaggle.predictions,function(x) {
        ifelse(x < 0,0,ifelse(x > 1,1,x))
    })
    )))
}
rownames(kaggle.classes) <- rownames(training.classes)
colnames(kaggle.classes) <- colnames(kaggle.features)
kaggle.classes %>% str()
mapping <-
read.csv("../data/scoring_and_test_set_id_mappings.csv",check.names = FALSE)
kaggle.out <- data.frame()
for (row in 1:nrow(mapping))
{
    kaggle.out <-
    rbind(kaggle.out,c(mapping[row,"id"],kaggle.classes[(mapping[row,"drug"]),(mapping[row,"cellline"])]))
}
colnames(kaggle.out) <- c('id','value')

fptr <- file(description = "./tuningSVM_out.csv",'w')
write.csv(kaggle.out,fptr,row.names = FALSE, quote = FALSE)
close(fptr)

print(
c(
    "all drug min errs:",x.all_drug_min_errs,"avg_err:",sum(x.all_drug_min_errs) / length(x.all_drug_min_errs)
)
)
